<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>The Critic – agentic</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="The Critic – agentic">
<meta property="og:description" content="Sample implementations of agentic research papers">
<meta property="og:site_name" content="agentic">
<meta name="twitter:title" content="The Critic – agentic">
<meta name="twitter:description" content="Sample implementations of agentic research papers">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">agentic</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./critic.html">The Critic</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">agentic</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./critic.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">The Critic</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./agent_coder.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Agent Coder</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./parallel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Branches for parallel node execution</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./buffer_of_thought.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Buffer of Thoughts (BoT)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./download_bot_datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Datasets</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Utility Functions</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#key-features" id="toc-key-features" class="nav-link active" data-scroll-target="#key-features">Key Features</a></li>
  <li><a href="#applications" id="toc-applications" class="nav-link" data-scroll-target="#applications">Applications</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#prompts" id="toc-prompts" class="nav-link" data-scroll-target="#prompts">Prompts</a></li>
  <li><a href="#runnables" id="toc-runnables" class="nav-link" data-scroll-target="#runnables">Runnables</a></li>
  <li><a href="#states" id="toc-states" class="nav-link" data-scroll-target="#states">States</a>
  <ul class="collapse">
  <li><a href="#state-of-the-critic-agent" id="toc-state-of-the-critic-agent" class="nav-link" data-scroll-target="#state-of-the-critic-agent">State of the Critic Agent</a></li>
  <li><a href="#modifications-to-align-with-practical-implementation" id="toc-modifications-to-align-with-practical-implementation" class="nav-link" data-scroll-target="#modifications-to-align-with-practical-implementation">Modifications to Align with Practical Implementation</a></li>
  <li><a href="#rationale-for-full-message-history" id="toc-rationale-for-full-message-history" class="nav-link" data-scroll-target="#rationale-for-full-message-history">Rationale for Full Message History</a></li>
  <li><a href="#criticstate" id="toc-criticstate" class="nav-link" data-scroll-target="#criticstate">CriticState</a></li>
  </ul></li>
  <li><a href="#nodes" id="toc-nodes" class="nav-link" data-scroll-target="#nodes">Nodes</a>
  <ul class="collapse">
  <li><a href="#tools" id="toc-tools" class="nav-link" data-scroll-target="#tools">tools</a></li>
  <li><a href="#assistant" id="toc-assistant" class="nav-link" data-scroll-target="#assistant">assistant</a></li>
  </ul></li>
  <li><a href="#conditional-edges" id="toc-conditional-edges" class="nav-link" data-scroll-target="#conditional-edges">Conditional Edges</a>
  <ul class="collapse">
  <li><a href="#tool_call" id="toc-tool_call" class="nav-link" data-scroll-target="#tool_call">tool_call</a></li>
  </ul></li>
  <li><a href="#build-the-graph" id="toc-build-the-graph" class="nav-link" data-scroll-target="#build-the-graph">Build the Graph</a></li>
  <li><a href="#run-the-agent" id="toc-run-the-agent" class="nav-link" data-scroll-target="#run-the-agent">Run the Agent</a>
  <ul class="collapse">
  <li><a href="#define-configuration" id="toc-define-configuration" class="nav-link" data-scroll-target="#define-configuration">Define Configuration</a></li>
  <li><a href="#gsm8k" id="toc-gsm8k" class="nav-link" data-scroll-target="#gsm8k">GSM8K</a></li>
  <li><a href="#ambigqa" id="toc-ambigqa" class="nav-link" data-scroll-target="#ambigqa">AmbigQA</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/lubok-dot/agentic/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="critic.html.md"><i class="bi bi-file-code"></i>CommonMark</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">The Critic</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>The <a href="https://arxiv.org/abs/2305.11738">CRITIC framework</a><span class="citation" data-cites="Critic">(<a href="#ref-Critic" role="doc-biblioref">Gou et al. 2024</a>)</span> is designed to enhance the reliability of Large Language Models (LLMs) by incorporating a human-like verify-then-correct approach. It leverages external tools to validate and iteratively refine outputs generated by LLMs. This framework addresses common issues such as hallucinations, faulty reasoning, and toxicity in LLM-generated content. In the subsequent notebook we focus on Question-Answering and Mathematical Reasoning.</p>
<section id="key-features" class="level3">
<h3 class="anchored" data-anchor-id="key-features">Key Features</h3>
<ol type="1">
<li><strong>Verification:</strong> External tools critique the LLM’s generated output for accuracy and consistency.</li>
<li><strong>Correction:</strong> The LLM uses feedback from the critiques to improve its output.</li>
<li><strong>Iterative Refinement:</strong> The process repeats until the output satisfies predefined criteria.</li>
</ol>
</section>
<section id="applications" class="level3">
<h3 class="anchored" data-anchor-id="applications">Applications</h3>
<ul>
<li><strong>Free-form Question Answering:</strong> Improves truthfulness and factual accuracy by querying a search engine.</li>
<li><strong>Mathematical Reasoning:</strong> Solves Mathematical problems by translating them into Python code which is then executed in a confined environment.</li>
</ul>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
</section>
<section id="prompts" class="level2">
<h2 class="anchored" data-anchor-id="prompts">Prompts</h2>
<p>The attribute <span class="math inline">\(p\)</span> of the state of the Critic Agent.</p>
<div id="cell-5" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> SystemMessage(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    textwrap.dedent(</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"""</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="st">    Perform the tasks of question answering and mathematical problem solving by interacting with the Internet via TavilySearch and executing Python code respectively. Use TavilySearch for context retrieval in free-form question answering and Python code for mathematical problem synthesis. Align the approaches with the AmbigNQ and GSMK8 datasets.</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="st">    # Task Descriptions</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="st">    1. **Question Answering:**</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="st">       - Retrieve context using TavilySearch to search the Internet and to provide accurate answers to factual questions.</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="st">       - Focus on truthfulness and plausibility checks during verification.</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="st">    2. **Mathematical Problem Solving:**</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="st">       - Generate Python code execution to solve mathematical problems effectively.</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="st">       - Run the Python Code by Calling the RIZA Code Interpreter. Ensure that your final result is printed. That is, the generated code should always end with a print statement ```print(...)``` which prints the final result.</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="st">       - Ensure the correctness of calculations and consider plausible reasoning before final conclusions.</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="st">    # Steps</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="st">    1. **Input Processing**: Given a query, determine whether it is a factual question or a mathematical problem.</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="st">    2. **Context Retrieval/Execution**:</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="st">       - For factual questions, utilize the Internet to extract relevant information.</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="st">       - For mathematical problems, generate Python code and execute it to derive the answer.</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="st">    3. **Verification and Correction**:</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="st">       - Verify factual information retrieved from the Internet using TavilySearch to ensure it is up-to-date and correct.</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="st">       - Verify mathematical solutions by evaluating the Python execution for accuracy and logical consistency.</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="st">    4. **Generate Answer**: Conclude with a verified answer, ensuring that any corrections have been applied based on the verification steps.</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="st">    # Output Format</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="st">    - **Response Type**: Structured text with a clear final answer.</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="st">    - **Formatting**: For factual answers, provide the main conclusion last. For mathematical solutions, display the final numeric answer only.</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="st">    # Examples</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="st">    1. **Question Answering Example**:</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="st">       - **Input**: Which performance act has a higher instrument to person ratio, Badly Drawn Boy or Wolf Alice?</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="st">       </span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="st">       - **Process**:</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="st">         Proposed Answer: </span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="st">            Let’s think step by step. Badly Drawn Boy is a solo act with one person and one instrument. Wolf Alice is a band with four</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="st">            people and multiple instruments. So Wolf Alice has a higher instrument to person ratio. So the answer is: Wolf Alice. What’s </span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="st">            the problem with the above answer?</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="st">         1. Plausibility:</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="st">            The question asks for a name, and the answer "Wolf Alice" is a name. So it’s plausible.</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="st">         2. Truthfulness:</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a><span class="st">            Let’s search the question in the Internet:</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="st">            &gt; Search Query: Which performance act has a higher instrument to person ratio, Badly Drawn Boy or Wolf Alice?</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="st">            &gt; Evidence: [nlpproject2023/Sentences - Datasets at Hugging Face] ...Wolf Alice are a four-piece alternative rock band from... The evidence suggests that Wolf Alice is a four-piece alternative rock band.</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a><span class="st">            Let’s search the proposed answer in the Internet:</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="st">            &gt; Search Query: Badly Drawn Boy is a solo instrument.</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="st">            &gt; Evidence: act with one person and one</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a><span class="st">            [Badly Drawn Boy - TavilySearch] Singer-songwriter - Guitar, vocals, bass, drums, percussion, banjo, piano, keyboards, harmonica - 1995-present... Missing: act | Must include: act The evidence suggests that </span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="st">            Badly Drawn Boy is a singer-songwriter with multiple instruments. We need to find out the instrument to person ratio of both acts.</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="st">            &gt; Search Query: What is the instrument to Boy?</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="st">            &gt; Evidence: [Badly Drawn Boy - TavilySearch] person ratio of Badly Drawn ... consisted of Matt Wardle</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="st">            (keyboards/vocals), Robin File (guitar), Sean McCann (bass guitar) latterly replaced by the ex-Smiths bass guitarist Andy Rourke, Dave Verner (drums).</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="st">            The evidence suggests that the instrument to person ratio of Badly Drawn Boy is 4:1.</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="st">            &gt; Search Query: &gt; Evidence: What is the instrument to person ratio of Wolf Alice?</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="st">            [Wolf Alice - TavilySearch] ...Formed in 2010 as an acoustic duo comprising singer Ellie Rowsell and guitarist Joff Oddie, Wolf Alice have also featured bassist Theo Ellis and drummer Joel Amey since 2012...</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a><span class="st">            The evidence suggests that the instrument to person ratio of Wolf Alice is 1:1.</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="st">            The proposed answer is incorrect since Badly Drawn Boy has a higher instrument to person ratio than Wolf Alice.</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a><span class="st">         Question: Which performance act has a higher instrument to person ratio, Badly Drawn Boy or Wolf Alice?</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a><span class="st">         Here’s the most possible answer: Let’s think step by step. Badly Drawn Boy is a solo act with four people and multiple instruments. Wolf Alice is a band with four people and one instrument. So Badly Drawn</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="st">         Boy has a higher instrument to person ratio. So the answer is: Badly Drawn Boy.</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="st">       - **Output**: Badly Drawn Boy</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a><span class="st">    2. **Mathematical Problem Solving Example**:</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="st">       - **Input**: Generally, a 5-year-old avocado tree produces 50 fruits, a 6-year-old one produces 3 times the initial amount of fruits, a 7-year-</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a><span class="st">                  old one produces 7 times the initial amount, and an 8-year-old produces 200 fruits less than a 10-year-old one. During the ninth</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a><span class="st">                  year, the avocado tree doesn’t produce any fruit, and then a 10-year-old tree produces 20 times the initial amount of fruits. How many</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a><span class="st">                  total fruits can an avocado tree produce during its 10 years of life?</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a><span class="st">       </span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a><span class="st">       - **Process**:</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a><span class="st">         ```python</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a><span class="st">         initial_fruits = 50</span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a><span class="st">         num_of_fruits_in_6th_year = 3 * initial_fruits</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a><span class="st">         num_of_fruits_in_7th_year = 7 * initial_fruits</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a><span class="st">         num_of_fruits_in_8th_year = num_of_fruits_in_10th_year - 200</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a><span class="st">         num_of_fruits_in_10th_year = 20 * initial_fruits</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a><span class="st">         answer = initial_fruits + num_of_fruits_in_6th_year + num_of_fruits_in_7th_year + num_of_fruits_in_8th_year + num_of_fruits_in_10th_year</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a><span class="st">         print(answer)  # Ensure the final result is explicitly printed</span></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a><span class="st">         ```</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a><span class="st">         Execution: NameError("name ’num_of_fruits_in_10th_year’ is not defined")</span></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a><span class="st">         Output: answer = None</span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a><span class="st">         What’s the problem with the above code?</span></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a><span class="st">         1. The above code causes the "NameError" because it use the variable ‘num_of_fruits_in_10th_year‘ before it is defined.</span></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a><span class="st">         2. The order of the calculation is not correct, ‘num_of_fruits_in_8th_year‘ should be calculated after ‘num_of_fruits_in_10th_year‘.</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a><span class="st">         Let’s analysis the problem, we can calculate the number of fruits for each year based on the description in the question.</span></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a><span class="st">         Here’s a better solution:</span></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a><span class="st">         ‘‘‘python</span></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a><span class="st">         initial_fruits = 50</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a><span class="st">         num_of_fruits_in_6th_year = 3 * initial_fruits</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a><span class="st">         num_of_fruits_in_7th_year = 7 * initial_fruits</span></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a><span class="st">         num_of_fruits_in_9th_year = 0</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a><span class="st">         num_of_fruits_in_10th_year = 20 * initial_fruits</span></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a><span class="st">         num_of_fruits_in_8th_year = num_of_fruits_in_10th_year - 200</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a><span class="st">         total_fruits = (</span></span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a><span class="st">         initial_fruits</span></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a><span class="st">         + num_of_fruits_in_6th_year</span></span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a><span class="st">         + num_of_fruits_in_7th_year</span></span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a><span class="st">         + num_of_fruits_in_8th_year</span></span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a><span class="st">         + num_of_fruits_in_9th_year</span></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a><span class="st">         + num_of_fruits_in_10th_year</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a><span class="st">         )</span></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a><span class="st">         answer = total_fruits</span></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a><span class="st">         print(answer)  # Ensure the final result is explicitly printed</span></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a><span class="st">         ‘‘‘</span></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a><span class="st">         Execution: Output: Done</span></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a><span class="st">         answer = 2350.0</span></span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a><span class="st">       - **Output**: 2350.0</span></span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a><span class="st">    # Notes</span></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a><span class="st">    - For ambiguous questions, use multiple sources to triangulate the most accurate information.</span></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a><span class="st">    - For mathematical errors, iterate the correction until logical consistency is achieved.</span></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a><span class="st">    - Ensure that the final answer of your code is always explicitly printed using `print()`.</span></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>    ).strip()</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="runnables" class="level2">
<h2 class="anchored" data-anchor-id="runnables">Runnables</h2>
<p>CRITIC integrates external tools to perform verification tasks:</p>
<ul>
<li><strong><a href="https://python.langchain.com/docs/integrations/tools/tavily_search/#tool-features">Tavily Search</a>(TavilySearchResults):</strong>
<ul>
<li>Validates factual correctness.</li>
<li>Retrieves and processes web-based evidence.</li>
</ul></li>
<li><strong><a href="https://python.langchain.com/docs/integrations/tools/riza/#related">Riza Code Interpreter</a> (ExecPython):</strong>
<ul>
<li>Executes Python code to support the LLM’s mathematical reasoning.</li>
<li>Provides feedback on execution results and errors.</li>
</ul></li>
</ul>
<p><strong>Key Points</strong></p>
<ul>
<li>Tavily Search: Configured to retrieve detailed search results, supporting robust verification for question answering.</li>
<li>RIZA Code Intperpreter: Executes Python programs to assess correctness and provide feedback on mathematical reasoning tasks which are translated into python code.</li>
<li>TOOL_MAP: Organizes tools for seamless execution: we can call each tool by its name.</li>
</ul>
<p>Next, we instantiate a Large Language Model.</p>
</section>
<section id="states" class="level2">
<h2 class="anchored" data-anchor-id="states">States</h2>
<p>We implement the Critic Agent as outlined in Algorithm 1 of the <a href="http://arxiv.org/abs/2305.11738">Critic Paper</a><span class="citation" data-cites="Critic">(<a href="#ref-Critic" role="doc-biblioref">Gou et al. 2024</a>)</span>. The agent is implemented using <a href="https://langchain-ai.github.io/langgraph/tutorials/introduction/">LangGraph</a>, a framework that defines agents as state machines represented as graphs.</p>
<ul>
<li><strong>Nodes</strong>: Each node in the graph is a function that takes the state as input and returns an updated version of the state as output.</li>
<li><strong>Edges</strong>: Each edge connects nodes and dictates transitions between them.</li>
</ul>
<section id="state-of-the-critic-agent" class="level3">
<h3 class="anchored" data-anchor-id="state-of-the-critic-agent">State of the Critic Agent</h3>
<p>The state of the Critic Agent contains the following attributes:</p>
<ul>
<li><strong><span class="math inline">\(p\)</span></strong>: The system prompt.</li>
<li><strong><span class="math inline">\(x\)</span></strong>: The input message.</li>
<li><strong><span class="math inline">\(y\)</span></strong>: The entire message history, stored as a list <span class="math inline">\([y_0, y_1, ..., y_i]\)</span> instead of just the latest output message <span class="math inline">\(y_i\)</span>. This approach aligns with examples such as those in the Appendix of <span class="citation" data-cites="Critic">(<a href="#ref-Critic" role="doc-biblioref">Gou et al. 2024</a>)</span>.</li>
<li><strong><span class="math inline">\(c\)</span></strong>: The responses of external tools (the critiques).</li>
</ul>
</section>
<section id="modifications-to-align-with-practical-implementation" class="level3">
<h3 class="anchored" data-anchor-id="modifications-to-align-with-practical-implementation">Modifications to Align with Practical Implementation</h3>
<p>Compared to the pseudo-code in Algorithm 1, we modify the state of the Critic Agent as follows:</p>
<ol type="1">
<li><strong>Message History (<span class="math inline">\(y\)</span>)</strong>: Instead of storing only the latest output <span class="math inline">\(y_i\)</span>, we maintain the full history of messages <span class="math inline">\([y_0, y_1, ..., y_i]\)</span>. This change ensures richer context availability during the iterative process. For instance, in tasks like TriviaQA (Appendix of <span class="citation" data-cites="Critic">(<a href="#ref-Critic" role="doc-biblioref">Gou et al. 2024</a>)</span>), maintaining full history facilitates better verification and correction.</li>
<li><strong>Iteration Tracking</strong>: We store the number of iterations the agent has gone through the critic stage. This attribute ensures that the process halts after a user-defined maximum number of iterations, preventing infinite loops.</li>
</ol>
</section>
<section id="rationale-for-full-message-history" class="level3">
<h3 class="anchored" data-anchor-id="rationale-for-full-message-history">Rationale for Full Message History</h3>
<p>The choice to store the entire message history (<span class="math inline">\(y\)</span>) instead of just the latest output (<span class="math inline">\(y_i\)</span>) is demonstrated in practical applications, such as the TriviaQA example in the Critic Paper. In this example:</p>
<ul>
<li>The question requires determining <em>which innovation for the car was developed by Prince Henry of Prussia in 1911</em>. To answer:
<ul>
<li>The Critic Agent first queries information about Prince Henry of Prussia to identify his contributions and historical context.</li>
<li>Subsequently, the agent queries information on innovations he developed in 1911 to pinpoint the car-related invention.</li>
</ul></li>
<li>Retaining the full history allows the second query to reference outputs from the first query, ensuring consistency and accuracy in the iterative reasoning process.</li>
</ul>
<p>Without full message history, the Critic Agent might lose context from earlier tool outputs, leading to incomplete or inconsistent answers. By maintaining all intermediate steps and critiques, the agent ensures comprehensive and context-aware responses. This design choice is critical for multi-step, tool-dependent tasks where earlier results inform later reasoning.</p>
<hr>
<p><a href="https://github.com/lubok-dot/agentic/blob/main/agentic/critic.py#L46" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="criticstate" class="level3">
<h3 class="anchored" data-anchor-id="criticstate">CriticState</h3>
<blockquote class="blockquote">
<pre><code> CriticState (p:langchain_core.messages.system.SystemMessage,
              x:langchain_core.messages.human.HumanMessage,
              y:list[langchain_core.messages.base.BaseMessage]=[],
              c:list[langchain_core.messages.tool.ToolMessage]=[],
              num_iterations:int=0)</code></pre>
</blockquote>
<p><em>Represents the state of the Critic during execution, as defined in Algorithm 1 of the referenced paper.</em></p>
</section>
</section>
<section id="nodes" class="level2">
<h2 class="anchored" data-anchor-id="nodes">Nodes</h2>
<p>The Critic Agent’s graph has two nodes, <a href="https://lubok-dot.github.io/agentic/critic.html#assistant"><code>assistant</code></a> and <a href="https://lubok-dot.github.io/agentic/critic.html#tools"><code>tools</code></a>, which collaborate to iteratively answer the query.</p>
<ul>
<li><strong><a href="https://lubok-dot.github.io/agentic/critic.html#assistant"><code>assistant</code></a> Node</strong>:
<ul>
<li><strong>Input</strong>: The initial question and the <code>Observation</code> (result of a tool invocation).</li>
<li><strong>Processing</strong>:
<ul>
<li>The <code>assistant</code> generates a <code>Thought</code> by reasoning about whether the current information is sufficient to answer the question.</li>
<li>If more information is needed, the <code>assistant</code> generates an <code>Action</code>, specifying a tool call and its arguments (e.g., search query for Tavily Search or Python code for Riza Code Interpreter).</li>
</ul></li>
<li><strong>Output</strong>: A <code>Thought</code> (decision) and, if needed, an <code>Action</code> (tool call).</li>
</ul></li>
<li><strong><a href="https://lubok-dot.github.io/agentic/critic.html#tools"><code>tools</code></a> Node</strong>:
<ul>
<li><strong>Input</strong>: The <code>Action</code> generated by the <a href="https://lubok-dot.github.io/agentic/critic.html#assistant"><code>assistant</code></a>.</li>
<li><strong>Execution</strong>: Invokes the specified tool with the provided arguments and retrieves the result.</li>
<li><strong>Output</strong>: An <code>Observation</code>, which is passed back to the <a href="https://lubok-dot.github.io/agentic/critic.html#assistant"><code>assistant</code></a>.</li>
</ul></li>
</ul>
<section id="example-triviaqa" class="level4">
<h4 class="anchored" data-anchor-id="example-triviaqa">Example (TriviaQA):</h4>
<p>For the question <em>“Which innovation for the car was developed by Prince Henry of Prussia in 1911?”</em>:</p>
<ol type="1">
<li>The <a href="https://lubok-dot.github.io/agentic/critic.html#assistant"><code>assistant</code></a> node receives the query and decides to search for information about Henry of Prussia, generating an <code>Action</code> (search query).</li>
<li>The <a href="https://lubok-dot.github.io/agentic/critic.html#tools"><code>tools</code></a> node executes the search and returns the result (<code>Observation</code>) to the <a href="https://lubok-dot.github.io/agentic/critic.html#assistant"><code>assistant</code></a>.</li>
<li>The <a href="https://lubok-dot.github.io/agentic/critic.html#assistant"><code>assistant</code></a> evaluates the observation, determines that more information is needed, and generates another <code>Action</code> to search for innovations by Prince Henry.</li>
<li>The <a href="https://lubok-dot.github.io/agentic/critic.html#tools"><code>tools</code></a> node performs the second search, and the result allows the <a href="https://lubok-dot.github.io/agentic/critic.html#assistant"><code>assistant</code></a> to conclude the answer.</li>
</ol>
<p>This iterative process continues until the <a href="https://lubok-dot.github.io/agentic/critic.html#assistant"><code>assistant</code></a> determines the answer or a termination condition is met (e.g., maximum iterations).</p>
</section>
<section id="interaction-and-graph-dynamics" class="level4">
<h4 class="anchored" data-anchor-id="interaction-and-graph-dynamics">Interaction and Graph Dynamics:</h4>
<p>The Critic Agent operates as a state machine:</p>
<ul>
<li><strong>Nodes</strong>: Functions that process and transform the agent’s state.</li>
<li><strong>Edges</strong>: Transitions between nodes based on the agent’s decisions (<code>Thought</code> and <code>Action</code>).</li>
</ul>
</section>
<section id="state-attributes-as-independent-channels" class="level4">
<h4 class="anchored" data-anchor-id="state-attributes-as-independent-channels">State Attributes as Independent Channels</h4>
<p>In LangGraph, each attribute of the state, such as <code>p</code>, <code>x</code>, <code>c</code>, and <code>y</code>, functions as an independent <strong>channel</strong> that can be updated individually.</p>
<ul>
<li><strong>Partial Updates</strong>: Functions operating on the state (nodes) do not need to return a complete state object. Instead, they can selectively update one or more attributes (channels) while leaving the others unchanged.</li>
<li><strong>State Compilation</strong>: During the graph compilation process, LangGraph ensures that all node functions output a complete state object. It merges the unchanged attributes with the updated ones, creating a seamless transition between nodes.</li>
<li><strong>Example</strong>: In the <a href="https://lubok-dot.github.io/agentic/critic.html#assistant"><code>assistant</code></a> node, the function only updates the <code>y</code> attribute of the state. Similarly, the <a href="https://lubok-dot.github.io/agentic/critic.html#tools"><code>tools</code></a> node updates <code>c</code> and <code>num_iterations</code>. LangGraph handles the integration of these updates into the full state object.</li>
</ul>
<p>This feature simplifies node implementation and enhances modularity, as each node can focus solely on the attributes it directly affects. LangGraph ensures the consistency and integrity of the full state during execution.</p>
<hr>
<p><a href="https://github.com/lubok-dot/agentic/blob/main/agentic/critic.py#L81" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="tools" class="level3">
<h3 class="anchored" data-anchor-id="tools">tools</h3>
<blockquote class="blockquote">
<pre><code> tools (state:__main__.CriticState)</code></pre>
</blockquote>
<p><em>Executes sequential tool calls based on the provided critic state.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>state</td>
<td>CriticState</td>
<td>Current state of the Critic, containing tool calls and iteration data.</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>CriticState</strong></td>
<td><strong>Updated state with results from invoked tool calls and incremented iteration count.</strong></td>
</tr>
</tbody>
</table>
<hr>
<p><a href="https://github.com/lubok-dot/agentic/blob/main/agentic/critic.py#L62" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="assistant" class="level3">
<h3 class="anchored" data-anchor-id="assistant">assistant</h3>
<blockquote class="blockquote">
<pre><code> assistant (state:__main__.CriticState)</code></pre>
</blockquote>
<p><em>Processes the critic state by appending new results to the state history.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>state</td>
<td>CriticState</td>
<td>Current state of the Critic, containing past results and parameters.</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>CriticState</strong></td>
<td><strong>Updated state including new results from invoking the LLM.</strong></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="conditional-edges" class="level2">
<h2 class="anchored" data-anchor-id="conditional-edges">Conditional Edges</h2>
<p>The <a href="https://lubok-dot.github.io/agentic/critic.html#tool_call"><code>tool_call</code></a> function defines a conditional edge in the Critic Agent’s graph. This edge determines whether the agent invokes a tool for additional observations or concludes its execution.</p>
<ul>
<li><strong>Conditions</strong>:
<ol type="1">
<li><strong>No Pending Tool Calls</strong>:
<ul>
<li>If the most recent output (<code>state.y[-1]</code>) does not contain any tool calls, the agent assumes the assistant node has provided a satisfactory result validated by the Critic.</li>
<li>The agent transitions to the <code>END</code> node, returning the result as the final output.</li>
</ul></li>
<li><strong>Maximum Iterations Reached</strong>:
<ul>
<li>If the number of iterations (<code>state.num_iterations</code>) equals or exceeds the predefined limit (<code>MAX_NUM_ITERATIONS</code>), the agent forcefully terminates its process to prevent infinite loops.</li>
</ul></li>
</ol></li>
<li><strong>Code Logic</strong>: ```python return END if (not state.y[-1].tool_calls) or state.num_iterations &gt;= MAX_NUM_ITERATIONS else “tools”</li>
</ul>
<hr>
<p><a href="https://github.com/lubok-dot/agentic/blob/main/agentic/critic.py#L104" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="tool_call" class="level3">
<h3 class="anchored" data-anchor-id="tool_call">tool_call</h3>
<blockquote class="blockquote">
<pre><code> tool_call (state:__main__.CriticState)</code></pre>
</blockquote>
<p><em>Determines the next action for the Critic based on the current state.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>state</td>
<td>CriticState</td>
<td>The current state of the Critic, including the history of tool calls and the iteration count.</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>Literal</strong></td>
<td><strong>Returns ‘tools’ if additional tool calls are required and the maximum number of iterations<br>has not been reached. Returns END otherwise.</strong></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="build-the-graph" class="level2">
<h2 class="anchored" data-anchor-id="build-the-graph">Build the Graph</h2>
<p>LangGraph models applications as <strong>state machines</strong>, where the system transitions between defined states based on inputs and conditions. A state machine is a mathematical abstraction used to represent a system with a finite number of states, transitions, and actions. For more details, refer to the <a href="https://en.wikipedia.org/wiki/Finite-state_machine">Wikipedia article on finite-state machines</a>.</p>
<p>This cell defines the graph for the Critic Agent, representing its workflow as a state machine.</p>
<section id="key-components" class="level4">
<h4 class="anchored" data-anchor-id="key-components">Key Components:</h4>
<ol type="1">
<li><strong>State Class</strong>:
<ul>
<li>The <a href="https://lubok-dot.github.io/agentic/critic.html#criticstate"><code>CriticState</code></a> class defines the state of the agent, storing attributes such as the system prompt (<code>p</code>), input (<code>x</code>), message history (<code>y</code>), tool responses (<code>c</code>), and the number of iterations (<code>num_iterations</code>).</li>
</ul></li>
<li><strong>Nodes</strong>:
<ul>
<li>Nodes are <strong>functions mapping a state onto a new state</strong>. Each node takes a <a href="https://lubok-dot.github.io/agentic/critic.html#criticstate"><code>CriticState</code></a> as input and returns an updated <a href="https://lubok-dot.github.io/agentic/critic.html#criticstate"><code>CriticState</code></a> after performing a specific operation:
<ul>
<li><strong><code>assistant</code></strong>: Processes the current state to generate a <code>Thought</code> (decision) and an <code>Action</code> (e.g., a tool call).</li>
<li><strong><code>tools</code></strong>: Executes the specified tool action and updates the state with the resulting observation.</li>
</ul></li>
</ul></li>
<li><strong>Edges</strong>:
<ul>
<li>Edges are <strong>functions on states</strong> mapping them onto nodes. They dictate the control flow between them:
<ul>
<li><strong><code>START → assistant</code></strong>: The graph starts at the <code>assistant</code> node.</li>
<li><strong><code>assistant → tools</code> (Conditional Edge)</strong>:
<ul>
<li>The <code>tool_call</code> function determines whether to transition to the <code>tools</code> node or terminate the process based on whether additional tool calls are needed or the iteration limit is reached.</li>
</ul></li>
<li><strong><code>tools → assistant</code></strong>: After executing a tool action, control flows back to the <code>assistant</code> node for further reasoning.</li>
</ul></li>
</ul></li>
<li><strong>Graph Compilation</strong>:
<ul>
<li>The graph is constructed using LangGraph’s <code>StateGraph</code> and compiled with <code>builder.compile()</code> to produce the executable state machine (<code>critic</code>).</li>
</ul></li>
</ol>
</section>
<section id="workflow" class="level4">
<h4 class="anchored" data-anchor-id="workflow">Workflow:</h4>
<p>The Critic Agent alternates between reasoning (<a href="https://lubok-dot.github.io/agentic/critic.html#assistant"><code>assistant</code></a>) and tool execution (<a href="https://lubok-dot.github.io/agentic/critic.html#tools"><code>tools</code></a>) until:</p>
<ol type="1">
<li>It produces a satisfactory result validated by the Critic, or</li>
<li>It reaches the maximum iteration limit (<code>MAX_NUM_ITERATIONS</code>).</li>
</ol>
<p>This design ensures iterative improvement of the response while enforcing efficient termination when appropriate.</p>
<div id="cell-16" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>display(Image(critic.get_graph(xray<span class="op">=</span><span class="va">True</span>).draw_mermaid_png()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_critic_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="run-the-agent" class="level2">
<h2 class="anchored" data-anchor-id="run-the-agent">Run the Agent</h2>
<p>We evaluate the model on 5 examples each from GSM8K<span class="citation" data-cites="cobbe2021gsm8k">(<a href="#ref-cobbe2021gsm8k" role="doc-biblioref">Cobbe et al. 2021</a>)</span> and AmbigNQ<span class="citation" data-cites="min2020ambigqa">(<a href="#ref-min2020ambigqa" role="doc-biblioref">Min et al. 2020</a>)</span> <span class="citation" data-cites="kwiatkowski2019natural">(<a href="#ref-kwiatkowski2019natural" role="doc-biblioref">Kwiatkowski et al. 2019</a>)</span>. The <a href="https://github.com/openai/grade-school-math?utm_source=chatgpt.com">GSM8K</a> (Grade School Math 8K) dataset is a collection of 8.5K high-quality, linguistically diverse grade school math word problems. It is designed to evaluate the arithmetic reasoning capabilities of large language models (LLMs). The <a href="https://github.com/shmsw25/AmbigQA">AmbigNQ</a> dataset is a collection of 14k questions derived from the NQ-open benchmark, specifically designed to explore ambiguity in open-domain question answering. For further details, refer to the <a href="./utils/01_data.html">data utilities documentation</a>.</p>
<section id="define-configuration" class="level3">
<h3 class="anchored" data-anchor-id="define-configuration">Define Configuration</h3>
<p>When executing our agent, we can specify runtime parameters using the <code>config</code> argument in the <code>invoke</code> or <code>batch</code> methods. This argument accepts a <a href="https://python.langchain.com/api_reference/core/runnables/langchain_core.runnables.config.RunnableConfig.html"><code>RunnableConfig</code></a> instance to control the agent’s behavior. In this example, we set a recursion limit of 5 to prevent the agent from calling the same node more than five times. Additionally, we limit the agent to a maximum of five concurrent calls to the language model (LLM) during batch operations. While the recursion limit serves to cap the number of iterations, it’s important to note that exceeding this limit will cause the agent to exit with an error, rather than completing its execution.</p>
<div id="cell-18" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> RunnableConfig(recursion_limit<span class="op">=</span><span class="dv">5</span>, max_concurrency<span class="op">=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="gsm8k" class="level3">
<h3 class="anchored" data-anchor-id="gsm8k">GSM8K</h3>
<div id="cell-20" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>gsm8k <span class="op">=</span> [</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"question"</span>: <span class="st">"Janet</span><span class="ch">\u2019</span><span class="st">s ducks lay 16 eggs per day. She eats three for breakfast every morning and bakes muffins for her friends every day with four. She sells the remainder at the farmers' market daily for $2 per fresh duck egg. How much in dollars does she make every day at the farmers' market?"</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"answer"</span>: <span class="st">"Janet sells 16 - 3 - 4 = &lt;&lt;16-3-4=9&gt;&gt;9 duck eggs a day.</span><span class="ch">\n</span><span class="st">She makes 9 * 2 = $&lt;&lt;9*2=18&gt;&gt;18 every day at the farmer</span><span class="ch">\u2019</span><span class="st">s market.</span><span class="ch">\n</span><span class="st">#### 18"</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"question"</span>: <span class="st">"A robe takes 2 bolts of blue fiber and half that much white fiber.  How many bolts in total does it take?"</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"answer"</span>: <span class="st">"It takes 2/2=&lt;&lt;2/2=1&gt;&gt;1 bolt of white fiber</span><span class="ch">\n</span><span class="st">So the total amount of fabric is 2+1=&lt;&lt;2+1=3&gt;&gt;3 bolts of fabric</span><span class="ch">\n</span><span class="st">#### 3"</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"question"</span>: <span class="st">"Josh decides to try flipping a house.  He buys a house for $80,000 and then puts in $50,000 in repairs.  This increased the value of the house by 150%.  How much profit did he make?"</span>,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"answer"</span>: <span class="st">"The cost of the house and repairs came out to 80,000+50,000=$&lt;&lt;80000+50000=130000&gt;&gt;130,000</span><span class="ch">\n</span><span class="st">He increased the value of the house by 80,000*1.5=&lt;&lt;80000*1.5=120000&gt;&gt;120,000</span><span class="ch">\n</span><span class="st">So the new value of the house is 120,000+80,000=$&lt;&lt;120000+80000=200000&gt;&gt;200,000</span><span class="ch">\n</span><span class="st">So he made a profit of 200,000-130,000=$&lt;&lt;200000-130000=70000&gt;&gt;70,000</span><span class="ch">\n</span><span class="st">#### 70000"</span>,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"question"</span>: <span class="st">"James decides to run 3 sprints 3 times a week.  He runs 60 meters each sprint.  How many total meters does he run a week?"</span>,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"answer"</span>: <span class="st">"He sprints 3*3=&lt;&lt;3*3=9&gt;&gt;9 times</span><span class="ch">\n</span><span class="st">So he runs 9*60=&lt;&lt;9*60=540&gt;&gt;540 meters</span><span class="ch">\n</span><span class="st">#### 540"</span>,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"question"</span>: <span class="st">"Every day, Wendi feeds each of her chickens three cups of mixed chicken feed, containing seeds, mealworms and vegetables to help keep them healthy.  She gives the chickens their feed in three separate meals. In the morning, she gives her flock of chickens 15 cups of feed.  In the afternoon, she gives her chickens another 25 cups of feed.  How many cups of feed does she need to give her chickens in the final meal of the day if the size of Wendi's flock is 20 chickens?"</span>,</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"answer"</span>: <span class="st">"If each chicken eats 3 cups of feed per day, then for 20 chickens they would need 3*20=&lt;&lt;3*20=60&gt;&gt;60 cups of feed per day.</span><span class="ch">\n</span><span class="st">If she feeds the flock 15 cups of feed in the morning, and 25 cups in the afternoon, then the final meal would require 60-15-25=&lt;&lt;60-15-25=20&gt;&gt;20 cups of chicken feed.</span><span class="ch">\n</span><span class="st">#### 20"</span>,</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-21" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>states <span class="op">=</span> [CriticState(p<span class="op">=</span>p, x<span class="op">=</span>HumanMessage(content<span class="op">=</span>x[<span class="st">"question"</span>]))</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> x <span class="kw">in</span> gsm8k]</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>response_gsm8k <span class="op">=</span> [CriticState(<span class="op">**</span>state)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">for</span> state <span class="kw">in</span> critic.batch(states, config<span class="op">=</span>config)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-22" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ans, ground_truth <span class="kw">in</span> <span class="bu">zip</span>(response_gsm8k, gsm8k):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    ans.y[<span class="op">-</span><span class="dv">1</span>].pretty_print()</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"**Number of required iterations**: </span><span class="sc">{</span><span class="bu">len</span>(ans.y) <span class="op">//</span> <span class="dv">2</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"**Tool Called**: </span><span class="sc">{</span>ans<span class="sc">.</span>y[<span class="dv">0</span>]<span class="sc">.</span>tool_calls[<span class="dv">0</span>][<span class="st">'name'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"**Ground Truth**: </span><span class="sc">{</span>ground_truth[<span class="st">'answer'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================== Ai Message ==================================

Janet makes $18 every day at the farmers' market.
**Number of required iterations**: 1
**Tool Called**: riza_exec_python
**Ground Truth**: Janet sells 16 - 3 - 4 = &lt;&lt;16-3-4=9&gt;&gt;9 duck eggs a day.
She makes 9 * 2 = $&lt;&lt;9*2=18&gt;&gt;18 every day at the farmer’s market.
#### 18

================================== Ai Message ==================================

The total number of bolts of fiber needed for the robe is 3.0.
**Number of required iterations**: 1
**Tool Called**: riza_exec_python
**Ground Truth**: It takes 2/2=&lt;&lt;2/2=1&gt;&gt;1 bolt of white fiber
So the total amount of fabric is 2+1=&lt;&lt;2+1=3&gt;&gt;3 bolts of fabric
#### 3

================================== Ai Message ==================================

Josh made a profit of $120,000.
**Number of required iterations**: 1
**Tool Called**: riza_exec_python
**Ground Truth**: The cost of the house and repairs came out to 80,000+50,000=$&lt;&lt;80000+50000=130000&gt;&gt;130,000
He increased the value of the house by 80,000*1.5=&lt;&lt;80000*1.5=120000&gt;&gt;120,000
So the new value of the house is 120,000+80,000=$&lt;&lt;120000+80000=200000&gt;&gt;200,000
So he made a profit of 200,000-130,000=$&lt;&lt;200000-130000=70000&gt;&gt;70,000
#### 70000

================================== Ai Message ==================================

James runs a total of 540 meters a week.
**Number of required iterations**: 1
**Tool Called**: riza_exec_python
**Ground Truth**: He sprints 3*3=&lt;&lt;3*3=9&gt;&gt;9 times
So he runs 9*60=&lt;&lt;9*60=540&gt;&gt;540 meters
#### 540

================================== Ai Message ==================================

Wendi needs to give her chickens 20 cups of feed in the final meal of the day.
**Number of required iterations**: 1
**Tool Called**: riza_exec_python
**Ground Truth**: If each chicken eats 3 cups of feed per day, then for 20 chickens they would need 3*20=&lt;&lt;3*20=60&gt;&gt;60 cups of feed per day.
If she feeds the flock 15 cups of feed in the morning, and 25 cups in the afternoon, then the final meal would require 60-15-25=&lt;&lt;60-15-25=20&gt;&gt;20 cups of chicken feed.
#### 20
</code></pre>
</div>
</div>
<section id="observations-from-the-output" class="level4">
<h4 class="anchored" data-anchor-id="observations-from-the-output">Observations from the Output</h4>
<ol type="1">
<li>The CRITIC agent successfully translated mathematical problems into Python code and executed them using the Riza Code Interpreter tool.<br>
</li>
<li>The implementation achieved success on the first attempt, with no need for code revisions or re-writing.</li>
</ol>
</section>
</section>
<section id="ambigqa" class="level3">
<h3 class="anchored" data-anchor-id="ambigqa">AmbigQA</h3>
<div id="cell-24" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>ambigqa <span class="op">=</span> [</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"annotations"</span>: [</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"type"</span>: <span class="st">"singleAnswer"</span>, <span class="st">"answer"</span>: [<span class="st">"Tony Goldwyn"</span>, <span class="st">"Goldwyn"</span>]}</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"id"</span>: <span class="st">"-807825952267713091"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"question"</span>: <span class="st">"Who plays the doctor in dexter season 1?"</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"annotations"</span>: [</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>                <span class="st">"type"</span>: <span class="st">"singleAnswer"</span>,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>                <span class="st">"answer"</span>: [<span class="st">"usually continues uninterrupted until death"</span>],</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>                <span class="st">"type"</span>: <span class="st">"singleAnswer"</span>,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>                <span class="st">"answer"</span>: [<span class="st">"constant"</span>, <span class="st">"usually continues uninterrupted until death"</span>],</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"id"</span>: <span class="st">"8266116451988110240"</span>,</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"question"</span>: <span class="st">"How often does spermatogeneis</span><span class="ch">\u2014</span><span class="st">the production of sperm</span><span class="ch">\u2014</span><span class="st">occur?"</span>,</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"annotations"</span>: [</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"type"</span>: <span class="st">"singleAnswer"</span>, <span class="st">"answer"</span>: [<span class="st">"1950"</span>]},</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"type"</span>: <span class="st">"singleAnswer"</span>, <span class="st">"answer"</span>: [<span class="st">"1950"</span>]},</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"id"</span>: <span class="st">"7336174019902289593"</span>,</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"question"</span>: <span class="st">"When was the first remote control tv invented?"</span>,</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"annotations"</span>: [</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"type"</span>: <span class="st">"singleAnswer"</span>, <span class="st">"answer"</span>: [<span class="st">"10"</span>]},</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"type"</span>: <span class="st">"singleAnswer"</span>, <span class="st">"answer"</span>: [<span class="st">"10"</span>]},</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">"id"</span>: <span class="st">"9187719029377880470"</span>,</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"question"</span>: <span class="st">"How many episodes are in season 2 of chesapeake shores?"</span>,</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">"annotations"</span>: [</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"type"</span>: <span class="st">"singleAnswer"</span>, <span class="st">"answer"</span>: [<span class="st">"1919"</span>]},</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>                <span class="st">"type"</span>: <span class="st">"singleAnswer"</span>,</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>                <span class="st">"answer"</span>: [<span class="st">"October of that year"</span>, <span class="st">"October 1919"</span>],</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"id"</span>: <span class="st">"-6975273415196871312"</span>,</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">"question"</span>: <span class="st">"When was the first airline meal served during a flight?"</span>,</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-25" class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>states <span class="op">=</span> [CriticState(p<span class="op">=</span>p, x<span class="op">=</span>HumanMessage(content<span class="op">=</span>x[<span class="st">"question"</span>]))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> x <span class="kw">in</span> ambigqa]</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>response_ambigqa <span class="op">=</span> [</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    CriticState(<span class="op">**</span>state) <span class="cf">for</span> state <span class="kw">in</span> critic.batch(states, config<span class="op">=</span>config)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-26" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ans, ground_truth <span class="kw">in</span> <span class="bu">zip</span>(response_ambigqa, ambigqa):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    ans.y[<span class="op">-</span><span class="dv">1</span>].pretty_print()</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"**Number of required iterations**: </span><span class="sc">{</span><span class="bu">len</span>(ans.y) <span class="op">//</span> <span class="dv">2</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"**Tool Called**: </span><span class="sc">{</span>ans<span class="sc">.</span>y[<span class="dv">0</span>]<span class="sc">.</span>tool_calls[<span class="dv">0</span>][<span class="st">'name'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"**Ground Truth**: </span><span class="sc">{</span>ground_truth[<span class="st">"annotations"</span>][<span class="dv">0</span>][<span class="st">'answer'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================== Ai Message ==================================

In Season 1 of "Dexter," the character of the doctor who manages the care of Tony Tucci is portrayed by actress **Carmen Olivares**.
**Number of required iterations**: 1
**Tool Called**: tavily_search_results_json
**Ground Truth**: ['Tony Goldwyn', 'Goldwyn']

================================== Ai Message ==================================

Spermatogenesis is a continuous physiological process that occurs in the seminiferous epithelium of the testes. In humans, the entire process of spermatogenesis takes approximately 64 days to complete. However, sperm production occurs continuously, with an average of about 150 million sperm produced per day in a normal adult male.

**Final Answer**: Spermatogenesis occurs continuously, producing approximately 150 million sperm per day.
**Number of required iterations**: 1
**Tool Called**: tavily_search_results_json
**Ground Truth**: ['usually continues uninterrupted until death']

================================== Ai Message ==================================

The first remote control for a television was invented in 1950 by the Zenith Radio Corporation and was called "Lazy Bones." This remote was connected to the television by a long cord. Later, in 1955, Eugene Polley invented the first wireless remote control, known as the "Flash-Matic," which operated using beams of light. 

In summary, the first remote control TV was invented in 1950.
**Number of required iterations**: 1
**Tool Called**: tavily_search_results_json
**Ground Truth**: ['1950']

================================== Ai Message ==================================

Season 2 of *Chesapeake Shores* consists of 10 episodes.
**Number of required iterations**: 1
**Tool Called**: tavily_search_results_json
**Ground Truth**: ['10']

================================== Ai Message ==================================

The first airline meal was served on October 11, 1919, during a flight from London to Paris aboard a Handley Page Transport flight. Passengers had to pay 3 shillings for a cold lunch box that included sandwiches and fruit.
**Number of required iterations**: 1
**Tool Called**: tavily_search_results_json
**Ground Truth**: ['1919']
</code></pre>
</div>
</div>
<section id="observations-from-the-output-1" class="level4">
<h4 class="anchored" data-anchor-id="observations-from-the-output-1">Observations from the Output</h4>
<ol type="1">
<li>The CRITIC agent successfully translated QA problems into search requests handled with TavilySearch.</li>
<li>The implementation achieved success on the first attempt, with no need for further searches.</li>
</ol>



</section>
</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-cobbe2021gsm8k" class="csl-entry" role="listitem">
Cobbe, Karl, Vineet Kosaraju, Mohammad Bavarian, Mark Chen, Heewoo Jun, Lukasz Kaiser, Matthias Plappert, et al. 2021. <span>“Training Verifiers to Solve Math Word Problems.”</span> <em>arXiv Preprint arXiv:2110.14168</em>.
</div>
<div id="ref-Critic" class="csl-entry" role="listitem">
Gou, Zhibin, Zhihong Shao, Yeyun Gong, Yelong Shen, Yujiu Yang, Nan Duan, and Weizhu Chen. 2024. <span>“CRITIC: Large Language Models Can Self-Correct with Tool-Interactive Critiquing.”</span> <a href="https://arxiv.org/abs/2305.11738">https://arxiv.org/abs/2305.11738</a>.
</div>
<div id="ref-kwiatkowski2019natural" class="csl-entry" role="listitem">
Kwiatkowski, Tom, Jennimaria Palomaki, Olivia Redfield, Michael Collins, Ankur Parikh, Chris Alberti, Danielle Epstein, et al. 2019. <span>“Natural Questions: A Benchmark for Question Answering Research.”</span> <em>Transactions of the Association for Computational Linguistics</em>.
</div>
<div id="ref-min2020ambigqa" class="csl-entry" role="listitem">
Min, Sewon, Julian Michael, Hannaneh Hajishirzi, and Luke Zettlemoyer. 2020. <span>“<span>A</span>mbig<span>QA</span>: Answering Ambiguous Open-Domain Questions.”</span> In <em>EMNLP</em>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/lubok-dot\.github\.io\/agentic");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/lubok-dot/agentic/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>